<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <title>众创数字资产综合运营管理平台</title>
    <link rel="stylesheet" href="../../layui/css/layui.css"/>
    <link rel="stylesheet" href="../../css/admin.css"/>
    <link rel="stylesheet" href="../../layui_files_upload/css/layui.css"/>
    <style>
        .layui-upload-img {
            width: 100px;
            height: 100px;
            margin: 0 10px 10px 0;
        }
    </style>
</head>
<body>
<form class="layui-form" action="" lay-filter="example">
    <table class="layui-table layui-table-add" lay-skin="nob">
        <tbody>

        <!--<tr>-->
        <!--<th>-->
        <!--标题-->
        <!--</th>-->
        <!--<td>-->
        <!--<div class="layui-form-item">-->
        <!--<label class="layui-form-label">单行输入框</label>-->
        <!--<div class="layui-input-block">-->
        <!--<input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input">-->
        <!--</div>-->
        <!--</div>-->
        <!--</td>-->
        <!--</tr>-->
        <tr>
            <th>
                一级分类
            </th>
            <td>
                <div class="layui-inline" id="layui-inline-stair">
                    <div class="layui-input-inline">
                        <select name="stair" lay-filter="stair" id="stair" lay-filter="stair" lay-verify="required" lay-reqtext="请选择课程的一级分类!" lay-search="">
                            <option value="">请选择课程的一级分类</option>
<!--                            <option value="2">form</option>-->
<!--                            <option value="3">layim</option>-->
<!--                            <option value="4">element</option>-->
<!--                            <option value="5">laytpl</option>-->
<!--                            <option value="6">upload</option>-->
<!--                            <option value="7">laydate</option>-->
<!--                            <option value="8">laypage</option>-->
<!--                            <option value="9">flow</option>-->
<!--                            <option value="10">util</option>-->
<!--                            <option value="11">code</option>-->
<!--                            <option value="12">tree</option>-->
<!--                            <option value="13">layedit</option>-->
<!--                            <option value="14">nav</option>-->
<!--                            <option value="15">tab</option>-->
<!--                            <option value="16">table</option>-->
<!--                            <option value="17">select</option>-->
<!--                            <option value="18">checkbox</option>-->
<!--                            <option value="19">switch</option>-->
<!--                            <option value="20">radio</option>-->
                        </select>
                    </div>
                </div>
                </div>
            </td>
        </tr>
        <tr>
            <th>
                二级分类
            </th>
            <td>
                <div class="layui-inline">
                    <div class="layui-input-inline" id="layui-inline-modules">
                        <select name="classifyId" id="modules" lay-verify="required" lay-reqtext="请选择课程的二级分类!" lay-search="">
                            <option value="">请选择课程的一级分类</option>
<!--                            <option value="1">layer</option>-->
<!--                            <option value="2">form</option>-->
<!--                            <option value="3">layim</option>-->
<!--                            <option value="4">element</option>-->
<!--                            <option value="5">laytpl</option>-->
<!--                            <option value="6">upload</option>-->
<!--                            <option value="7">laydate</option>-->
<!--                            <option value="8">laypage</option>-->
<!--                            <option value="9">flow</option>-->
<!--                            <option value="10">util</option>-->
<!--                            <option value="11">code</option>-->
<!--                            <option value="12">tree</option>-->
<!--                            <option value="13">layedit</option>-->
<!--                            <option value="14">nav</option>-->
<!--                            <option value="15">tab</option>-->
<!--                            <option value="16">table</option>-->
<!--                            <option value="17">select</option>-->
<!--                            <option value="18">checkbox</option>-->
<!--                            <option value="19">switch</option>-->
<!--                            <option value="20">radio</option>-->
                        </select>
                    </div>
                </div>
                </div>
            </td>
        </tr>
        <tr>
            <th>课程名称</th>
            <td>
                <!--表单元素必须包含此div,才可实现表单验证-->
                <div class="layui-form-item">
                    <div style="width: 30%;">
                        <input type="text" name="courseName" id="courseName" lay-verify="required|name" lay-reqtext="课程名称不能为空？"
                               placeholder="请输入此课程课程名称" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <th>价格(元)</th>
            <td>
                <!--表单元素必须包含此div,才可实现表单验证-->
                <div class="layui-form-item">
                    <div style="width: 30%;">
                        <input type="text" name="coursePrice" lay-verify="required|price" lay-reqtext="价格不能为空？"
                               placeholder="请输入课程价格,输入0免费" autocomplete="off" class="layui-input">
                        <input type="hidden" name="courseId">
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <th width="100"><span class="red">*</span>商品图片</th>
            <td>
                <input name="courseImage" type="hidden" class="layui-upload-hide" lay-verify="required|upload" lay-reqtext="图片不能不传？"
                       autocomplete="off">
                <div class="layui-upload">
                    <button type="button" class="layui-btn" id="test1">选择图片</button>
                    <div class="layui-upload-list">
                        <img class="layui-upload-img" id="demo1" onerror=null>
                        <p id="demoText"></p>
                    </div>
                    <button type="button" class="layui-btn" id="submit-pictures">提交图片</button>
                </div>
            </td>
        </tr>
        <tr>
            <th>退款有效期</th>
            <td>
                <!--表单元素必须包含此div,才可实现表单验证-->
                <div class="layui-form-item">
                    <div style="width: 30%;">
                        <input type="text" name="courseValidity" lay-verify="required|refund_date" lay-reqtext="有限期不能为空？"
                               placeholder="请输入课程退款有效期,输入0为永远可退" autocomplete="off" class="layui-input">
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <th><span class="red">*</span>课程简介</th>
            <td>
                <textarea name="courseBrief" placeholder="请输入课程简介" style="width:400px;" class="layui-textarea"></textarea>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit="" id="dminprogram-btn" lay-filter="demo1">立即修改</button>
            <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>


<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../layui_files_upload/layui.js"></script>
<script type="text/javascript" src="../../js/jquery-1.8.3.min.js"></script>
<script type="text/javascript">
    function child(courseId) {
        // console.log(courseId);
        $(function () {
            // alert(1);
            $.ajax({
                //请求方式
                type:'GET',
                //发送请求的地址
                url:'/guliClassify/findAllClassify?id='+0,
                //服务器返回的数据类型
                dataType:'json',
                //发送到服务器的数据，对象必须为key/value的格式，jquery会自动转换为字符串格式
                success:function(data){
                    for(var i = 0;i < data.object.length;i++){
                        var course = data.object[i];
                        var option = " <option value=\""+course.classifyId+"\">"+course.classifyName+"</option>";
                        var dd = "<dd lay-value='"+course.classifyId+"' class=''>"+course.classifyName+"</dd>";
                        $("#layui-inline-stair .layui-anim-upbit").append(dd);
                        $("#stair").append(option);
                    }
                    layui.form.render("select");//重新渲染 固定写法
                },
                error:function(jqXHR){
                    //请求失败函数内容
                    console.log(jqXHR);
                }
            });
            $.getJSON("/guliCourse/findCourseIdOneCourse","id="+courseId,function(json){
                // console.log(json);
                var course = json.object;
                layui.use(['jquery', 'form', 'layer', 'layedit', 'laydate'], function () {
                    var form = layui.form
                        , layer = layui.layer
                        , layedit = layui.layedit
                        , laydate = layui.laydate;
                    console.log( $("#stair").find("option[value='"+course.parentId+"']"));
                    $("#stair").find("option[value='"+course.parentId+"']").prop("selected",true);
                    form.render();
                    selectShow(course.parentId,course.classifyId);
                    form.val('example', {
                        "courseName": course.courseName // "name": "value"
                        ,"coursePrice": course.coursePrice
                        ,"courseImage": course.courseImage
                        ,"courseValidity": course.courseValidity
                        ,"courseBrief": course.courseBrief
                        ,"courseId": courseId
                    });
                });
                $("#demo1").attr("src","http://39.106.18.84/"+course.courseImage);
            });
        });
    }
    layui.use(['jquery', 'form', 'upload', 'layer', 'layedit', 'laydate'], function () {

        var $ = layui.jquery
            , upload = layui.upload;

        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate;

        //自定义验证规则
        form.verify({
            price: [
                /(^[1-9]\d*(\.\d{1,2})?$)|(^0(\.\d{1,2})?$)/
                , '价格只能为数字'
            ]
            , pass: [
                /^[\S]{6,12}$/
                , '密码必须6到12位，且不能出现空格'
            ]
            ,refund_date:[
                /^([0-9]*)$/
                ,'日期只能为整数'
        ]
            , content: function (value) {
                layedit.sync(editIndex);
            }
        });

        $("#test1").click(function () {
            $("#demo1").removeAttr("src");
            $(".layui-upload-hide").val("");
        });

        //普通图片上传
        var uploadInst = upload.render({
            elem: '#test1'
            , auto: false
            //后端接口
            , url: "/FastDFS/uploadPictures"
            , bindAction: "#submit-pictures"
            , field: "multipartFile"
            , size: 500000 //最大允许上传的文件大小
            , choose: function (obj) {//choose 不自动上传时可以
                //预读本地文件示例，不支持ie8
                obj.preview(function (index, file, result) {
                    $('#demo1').attr('src', result); //图片链接（base64）
                });
            }
            , done: function (res) {
                var hint = res.message;
                //如果上传失败
                if (res.code > 0) {
                    layer.open({
                        type:0
                        ,area:['30%', '30%']
                        ,title:"上传信息"
                        ,content: hint
                    });
                    return layer.msg('上传失败');
                }
                console.log(res);
                //上传成功
                layer.open({
                    type:0
                    ,area:['30%', '30%']
                    ,title:"上传信息"
                    ,content: hint
                });
                //将图片收藏路径放入图片input中
                $(".layui-upload-hide").val(res.src);
                $("#test1").attr("class","layui-btn layui-btn-disabled");
                $("#submit-pictures").attr("class","layui-btn layui-btn-disabled");
                // alert(res.data.src);

            }
            , error: function () {
                //演示失败状态，并实现重传
                var demoText = $('#demoText');
                demoText.html('<span class="layui-btn layui-btn-xs demo-retry">重试</span>');
                demoText.find('.demo-retry').on('click', function () {
                    uploadInst.upload();
                });
            }
        });
        // 添加课程
        $(document).on("click", ".activity", function() {
            layer.open({
                type:2
                ,area:['80%', '80%']
                ,title:"添加课程"
                ,content: '添加课程.html'
            });
        });
        //监听提交
        form.on('submit(demo1)', function (data) {
            // layer.alert(JSON.stringify(data.field), {
            //     title: '最终的提交信息'
            // });
            // var param = $("input:text,input:hidden,select,textarea").serialize();
            // alert(param);
            $.ajax({
                //请求方式
                type:'PUT',
                //发送请求的地址
                url:'/guliCourse/pudateCourseIdOneCourse',
                //服务器返回的数据类型
                dataType:'json',
                //发送到服务器的数据，对象必须为key/value的格式，jquery会自动转换为字符串格式
                data:JSON.stringify(data.field),
                contentType: "application/json",
                success:function(data){
                    console.log(data);
                    if(data.success==false){
                        layer.open({
                            type:0
                            ,area:['30%', '30%']
                            ,title:"上传信息"
                            ,content: data.message
                        });
                    }else{
                        layer.close(layer.index);
                        window.parent.location.reload();
                    }
                },
                error:function(jqXHR){
                    //请求失败函数内容
                    console.log(jqXHR);
                }
            });
            // var obj2 = JSON.parse(param);
            // console.log(obj2);
            // $.post("/guliCourse/addCourse",obj2,function (json) {
            //     console.log(json);
            // },'json')
            return false;
        });

        layui.form.on('select(stair)', function (data) {
            // console.log(data.elem); //得到select原始DOM对象
            // console.log(data.value); //得到被选中的值
            // console.log(data.othis); //得到美化后的DOM对象
            // alert(data.value);
            $("#modules").remove();
            $("#layui-inline-modules .layui-form-select").remove();
            var select = " <select name=\"classifyId\" id=\"modules\" lay-verify=\"required\" lay-reqtext=\"请选择课程的二级分类!\" lay-search=\"\">\n" +
            "                            <option value=\"\">请选择课程的一级分类</option>" +
            "</select>"
            $("#layui-inline-modules").append(select);
            selectShow(data.value,null);
        });

    });

    // function toJSON(stringName){
    //     var arr=new Array();
    //     arr=stringName.split('&');
    //     alert(arr.length);
    //     for (var i = 0;i < arr.length;i++){
    //
    //     }
    // }

    function selectShow(data,is){
        // alert(data+"id")
        if(data!=""){
            alert(data);
            $.ajax({
                //请求方式
                type:'GET',
                //发送请求的地址
                url:'/guliClassify/findAllClassify?id='+data,
                //服务器返回的数据类型
                dataType:'json',
                //发送到服务器的数据，对象必须为key/value的格式，jquery会自动转换为字符串格式
                success:function(data){
                    // layui.form.render("select");//重新渲染 固定写法
                    // $('#layui-inline-modules .layui-anim-upbit').empty();
                    // $('#modules').empty();
                    // $("#layui-inline-modules .layui-anim-upbit").append("<dd lay-value='' class=\"layui-select-tips\">请选择课程的二级分类</dd>")
                    // $("#modules").append("<option value=\"\">请选择课程的二级分类</option>");
                    // console.log(data);
                    for(var i = 0;i < data.object.length;i++){
                        var course = data.object[i];
                        var option = " <option value=\""+course.classifyId+"\">"+course.classifyName+"</option>";
                        var dd = "<dd lay-value='"+course.classifyId+"' class=''>"+course.classifyName+"</dd>";
                        $("#layui-inline-modules .layui-anim-upbit").append(dd)
                        $("#modules").append(option);
                    }
                    if(is != null || is != ""){
                        $("#modules").find("option[value='"+is+"']").prop("selected",true);
                    }
                   layui.form.render("select");//重新渲染 固定写法
                },
                error:function(jqXHR){
                    //请求失败函数内容
                    console.log(jqXHR);
                }
            });
        }
    }

    // function isCourseName(name) {
    //    if(name != ""){
    //        $.ajax({
    //            //请求方式
    //            type:'GET',
    //            //发送请求的地址
    //            url:'/guliCourse/isCourseName?courseName='+name,
    //            //服务器返回的数据类型
    //            dataType:'json',
    //            async:false, 			// 特别注意，同步请求将锁住浏览器，用户其它操作必须等待请求完成才可以执行。
    //            //发送到服务器的数据，对象必须为key/value的格式，jquery会自动转换为字符串格式
    //            success:function(data){
    //                console.log(data);
    //                return true;
    //            },
    //            error:function(jqXHR){
    //                //请求失败函数内容
    //                console.log(jqXHR);
    //            }
    //        });
    //    }else{
    //        return true;
    //    }
    // }
</script>
</body>
</html>